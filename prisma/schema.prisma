// Exitasy Database Schema
// PostgreSQL for production, SQLite for local development

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// NextAuth.js Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// User Role & Status Enums
// ============================================

enum UserRole {
  FOUNDER
  BUYER
  ADMIN
}

enum BuyerStatus {
  PENDING
  APPROVED
  REJECTED
}


enum IntroRequestStatus {
  NEW        // Buyer submitted, awaiting founder review
  ACCEPTED   // Founder accepted, intro initiated
  DECLINED   // Founder declined
  CONNECTED  // Both parties connected (deal in progress)
}


// ============================================
// User Model
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  username      String?   @unique
  email         String?   @unique
  emailVerified DateTime?
  password      String?
  image         String?
  bio           String?
  website       String?
  twitter       String?
  location      String?
  onboardingCompleted Boolean @default(false)

  // Role & Plan (Monetization)
  role          UserRole    @default(FOUNDER)
  buyerStatus   BuyerStatus? // Only for BUYER role: PENDING ??APPROVED/REJECTED
  plan          String    @default("free")    // free, buyer, pro

  // Stats
  guessAccuracy Float     @default(0)
  guessRank     Int       @default(0)
  totalGuesses  Int       @default(0)
  correctGuesses Int      @default(0)
  totalMRR      Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  badges        Badge[]
  startups      StartupMaker[]
  upvotes       Upvote[]
  comments      Comment[]
  guesses       Guess[]
  buyerInterests BuyerInterest[]
  buyerAccessRequests BuyerAccessRequest[]
  forumThreads  ForumThread[]
  forumReplies  ForumReply[]
  notifications Notification[]
  eventLogs     EventLog[]
  follows       Follow[]
}

model Badge {
  id        String    @id @default(cuid())
  type      String    // MAKER, VERIFIED_SELLER, TOP_GUESSER, REVENUE_100K, SOLD_STARTUP, EARLY_ADOPTER
  userId    String
  earnedAt  DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// Startup Model
// ============================================

model Startup {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  tagline         String
  description     String   @db.Text
  logo            String?
  website         String
  screenshots     String   @default("[]") @db.Text // JSON array
  videoUrl        String?

  // Revenue
  verificationStatus String @default("PENDING") // PENDING, VERIFIED, REJECTED
  verificationProvider String? // STRIPE, PADDLE, LEMON_SQUEEZY, MANUAL
  verificationProofUrl String?
  lastVerifiedAt  DateTime?
  currentMRR      Int      @default(0)
  growthMoM       Float    @default(0)
  revenueAge      Int      @default(0)

  // Stage
  stage           String   @default("MAKING_MONEY") // MAKING_MONEY, EXIT_READY, ACQUISITION_INTEREST, FOR_SALE, SOLD
  askingPrice     Int?
  saleMultiple    Float?
  saleIncludes    String   @default("[]") @db.Text // JSON array
  saleReason      String?  @db.Text
  sellabilityReasons String @default("[]") @db.Text // JSON array

  // Operations (for Deal page)
  targetUsers       String?  @db.Text // Target user persona
  monetizationModel String?  @db.Text // How the product makes money
  founderNote       String?  @db.Text // Founder's personal note

  // Engagement
  upvoteCount     Int      @default(0)
  commentCount    Int      @default(0)
  guessCount      Int      @default(0)
  buyerInterestCount Int   @default(0)

  // Meta
  categories      String   @default("[]") @db.Text // JSON array
  launchDate      DateTime?
  todayRank       Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  makers          StartupMaker[]
  upvotes         Upvote[]
  comments        Comment[]
  guesses         Guess[]
  buyerInterests  BuyerInterest[]
  buyerAccessRequests BuyerAccessRequest[]
  revenueSnapshots RevenueSnapshot[]
  eventLogs       EventLog[]
  follows         Follow[]
  trendScore      TrendScore?
}

model StartupMaker {
  id        String   @id @default(cuid())
  startupId String
  userId    String
  role      String   @default("maker")

  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([startupId, userId])
}

// ============================================
// Revenue Snapshot
// ============================================

model RevenueSnapshot {
  id          String   @id @default(cuid())
  startupId   String
  mrr         Int
  revenue30d  Int
  growthMoM   Float
  recordedAt  DateTime @default(now())

  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
}

// ============================================
// Engagement Models
// ============================================

model Upvote {
  id        String   @id @default(cuid())
  userId    String
  startupId String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([userId, startupId])
}

model Comment {
  id        String    @id @default(cuid())
  content   String    @db.Text
  userId    String
  startupId String
  parentId  String?
  upvotes   Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup   Startup   @relation(fields: [startupId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
}

model Guess {
  id        String   @id @default(cuid())
  userId    String
  startupId String
  range     String   // RANGE_0_1K, RANGE_1K_5K, RANGE_5K_10K, RANGE_10K_20K, RANGE_20K_50K, RANGE_50K_PLUS
  isCorrect Boolean?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([userId, startupId])
}

model BuyerInterest {
  id          String   @id @default(cuid())
  userId      String
  startupId   String
  isAnonymous Boolean  @default(true)
  message     String?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([userId, startupId])
}

// ============================================
// Buyer Access Request (Intro Request Flow)
// ============================================

model BuyerAccessRequest {
  id          String   @id @default(cuid())
  userId      String   // Buyer requesting access
  startupId   String   // Startup they want access to

  // Request Details
  companyName  String?  // Company or fund name
  message      String   @db.Text // Why you? - What they want to discuss
  budgetRange  String   // under_10k, 10k_25k, 25k_50k, 50k_100k, 100k_plus
  timeline     String   // asap, 1_month, 3_months, exploring
  buyerType    String   // first_time, serial, operator, investor
  operatorPlan String?  @db.Text // Optional: How they'd operate the business
  linkedinUrl  String?  // Optional LinkedIn for verification

  // Status
  status      IntroRequestStatus @default(NEW)
  reviewedAt  DateTime?
  reviewNote  String?  @db.Text // Founder's note when reviewing
  connectedAt DateTime? // When both parties connected

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([userId, startupId])
  @@index([startupId, status])
}

// ============================================
// Forum Models
// ============================================

model ForumThread {
  id           String   @id @default(cuid())
  title        String
  content      String   @db.Text
  category     String   // REVENUE_GROWTH, EXIT_STRATEGY, ACQUISITION, SHOW_TELL, AMA, WEEKLY_DISCUSSION
  userId       String?
  upvotes      Int      @default(0)
  replyCount   Int      @default(0)
  isPinned     Boolean  @default(false)
  isAutoGenerated Boolean @default(false)
  templateType String?  // WEEKLY_OVERRATED, WEEKLY_BOTTLENECK, WEEKLY_CHECKLIST, WEEKLY_MILESTONE
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies      ForumReply[]
}

model ForumReply {
  id        String      @id @default(cuid())
  content   String      @db.Text
  userId    String
  threadId  String
  parentId  String?
  upvotes   Int         @default(0)
  createdAt DateTime    @default(now())

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  parent    ForumReply? @relation("ReplyReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   ForumReply[] @relation("ReplyReplies")
}

// ============================================
// Notification Model
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // UPVOTE, COMMENT, REPLY, GUESS_RESULT, BUYER_INTEREST, MILESTONE, BADGE_EARNED, SYSTEM
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// Event Log (Activity Tracking)
// ============================================

model EventLog {
  id        String   @id @default(cuid())
  type      String   // STARTUP_SUBMITTED, STARTUP_VERIFIED, STARTUP_LAUNCHED, UPVOTED, COMMENTED, GUESSED, FOR_SALE_LISTED, SOLD
  startupId String?
  userId    String?
  metadata  String   @default("{}") @db.Text // JSON for extra data
  createdAt DateTime @default(now())

  startup   Startup? @relation(fields: [startupId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type, createdAt])
  @@index([startupId])
  @@index([userId])
}

// ============================================
// Follow/Watch Model
// ============================================

model Follow {
  id        String   @id @default(cuid())
  userId    String
  startupId String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([userId, startupId])
}

// ============================================
// Trend Score Cache (for performance)
// ============================================

model TrendScore {
  id           String   @id @default(cuid())
  startupId    String   @unique
  score        Float    @default(0)
  upvotes7d    Int      @default(0)
  comments7d   Int      @default(0)
  guesses7d    Int      @default(0)
  recencyBonus Float    @default(0)
  calculatedAt DateTime @default(now())

  startup      Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([score(sort: Desc)])
}
